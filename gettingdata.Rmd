---
title: "getting data"
output: html_document
---

```{r setup, include=FALSE}

install.packages("tidyverse")
library('httr')
library('jsonlite')
library('dplyr')
library('tidyr')
library('zoo')
library('purrr')
library('RCurl')
library('magrittr')
library('rvest')
library('ggplot2')

```

```{r getting dataset, include=FALSE}

clientID = "27c52ec6c1a1476a9f4a0f4e3943bb65"
secret = "39a186b653dc4a7a90d757ad5ddb6cfb"

response = POST(
  'https://accounts.spotify.com/api/token',
  accept_json(),
  authenticate(clientID, secret),
  body = list(grant_type = 'client_credentials'),
  encode = 'form',
  verbose()
)

token = content(response)$access_token
authorization.header = paste0("Bearer ", token)

weekly.top.songs = read_html("https://spotifycharts.com/regional/global/weekly/latest") %>%
  html_nodes("#content > div > div > div > span > table > tbody > tr > td.chart-table-image > a")

id.start = regexpr("/track/", weekly.top.songs)
id.end = regexpr('" target="', weekly.top.songs)

top.song.ids = substr(weekly.top.songs, id.start+7, id.end-1)

tracks = list()
features = list()
for (i in seq(1, length(weekly.top.songs), 50)) {
  ids = paste(unlist(top.song.ids[i:(i+49)]), sep=",", collapse=",")
  tracks = append(tracks, content(GET(url = paste0("https://api.spotify.com/v1/tracks?ids=", ids), config = add_headers(authorization = authorization.header)))$tracks)
  features = append(features, content(GET(url = paste0("https://api.spotify.com/v1/audio-features?ids=", ids), config = add_headers(authorization = authorization.header)))$audio_features)
}

features_df = data.frame()
for (i in 1:length(features)) {
  features_df = rbind(features_df, cbind(
    rank = i,
    title = tracks[[i]]$name,
    artist = tracks[[i]]$artists[[1]]$name,
    danceability = features[[i]]$danceability,
    energy = features[[i]]$energy,
    key = features[[i]]$key,
    loudness = features[[i]]$loudness,
    mode = features[[i]]$mode,
    speechiness = features[[i]]$speechiness,
    acousticness = features[[i]]$acousticness,
    instrumentalness = features[[i]]$instrumentalness,
    liveness = features[[i]]$liveness,
    valence = features[[i]]$valence,
    tempo = features[[i]]$tempo,
    duration_ms = features[[i]]$duration_ms,
    time_signature = features[[i]]$time_signature
  ))
}

print(features_df)

```
